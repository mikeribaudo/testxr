<!DOCTYPE html>
<html lang="en">

<head>
	<title>three.js webgl - materials - video - webcam</title>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
	<!-- <link type="text/css" rel="stylesheet" href="main.css"> -->
</head>

<body>


	<video id="video" style="display:none" autoplay playsinline></video>

	<script type="module">
		//import { OrbitControls } from 'https://cdn.skypack.dev/three@0.132.2/examples/jsm/controls/OrbitControls.js'

		import * as THREE from 'https://cdn.skypack.dev/three@0.132.2';
		//import { GLTFLoader } from 'https://cdn.skypack.dev/three@0.132.2/examples/jsm/loaders/GLTFLoader.js';
		var camera, scene, renderer, video, theModel, aspect, position, seethruPlane;

		init();
		animate();

		
		function init() {


			camera = new THREE.PerspectiveCamera(90, window.innerWidth / window.innerHeight, 1, 10000);
			

			scene = new THREE.Scene();
			
			video = document.getElementById('video');

			var texture = new THREE.VideoTexture(video);

			var geometry = new THREE.PlaneGeometry(2, 2);
			geometry.scale(0.5, 0.5, 0.5);
			var material = new THREE.MeshBasicMaterial({ map: texture });
			seethruPlane = new THREE.Mesh(geometry, material);
			
			//mesh.lookAt( camera.position );
			scene.add(seethruPlane);

			

			renderer = new THREE.WebGLRenderer({ antialias: true });
			renderer.setPixelRatio(window.devicePixelRatio);
			renderer.setSize(window.innerWidth, window.innerHeight);
			document.body.appendChild(renderer.domElement);

			//const controls = new OrbitControls( camera, renderer.domElement );
			//controls.enableZoom = false;
			//controls.enablePan = false;

			window.addEventListener('resize', onWindowResize);

			//

			if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {

				const constraints = { video: { width: 1284, height: 2778, facingMode: 'environment' } };

				navigator.mediaDevices.getUserMedia(constraints).then(function (stream) {

					// apply the stream to the video element used in the texture

					video.srcObject = stream;
					video.play();

				}).catch(function (error) {

					console.error('Unable to access the camera/webcam.', error);

				});

			} else {

				console.error('MediaDevices interface not available.');

			}









			//LoadGLTF('cube.glb');

		}

		function onWindowResize() {

			camera.aspect = window.innerWidth / window.innerHeight;
			camera.updateMatrixWorld(true)

			renderer.setSize(window.innerWidth, window.innerHeight);

		}

		function animate() {

			requestAnimationFrame(animate);

            camera.updateMatrixWorld(true)
            
		 position = new THREE.Vector3(-0,0,-20)	// TODO how come you got that offset on x ???
		seethruPlane.position.copy(position)
		camera.localToWorld(seethruPlane.position)
			renderer.render(scene, camera);

		}
        camera.matrixWorld.decompose( camera.position, camera.quaternion, camera.scale );	
		seethruPlane.quaternion.copy( camera.quaternion )

        var fov = THREE.Math.radToDeg(Math.atan(1/camera.projectionMatrix.elements[5]))*2;
	// console.log('fov', fov)
		
		//var elementWidth = parseFloat( arToolkitSource.domElement.style.width.replace(/px$/,''), 10 )
		//var elementHeight = parseFloat( arToolkitSource.domElement.style.height.replace(/px$/,''), 10 )
		
		var aspect = window.innerWidth / window.innerHeight

        seethruPlane.scale.y = Math.tan(THREE.Math.DEG2RAD * fov/2)*position.length() 
		// get seethruPlane aspect
		seethruPlane.scale.x = seethruPlane.scale.y * aspect
	

	</script>

</body>

</html>
